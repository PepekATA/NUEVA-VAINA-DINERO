<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .card {
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-warning {
            background-color: #ffc107;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">🤖 Trading Bot Dashboard</h1>
        
        <!-- Control Panel -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Control Panel</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <button id="startBot" class="btn btn-success btn-lg w-100">
                                    🚀 Start Robot
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="predictOnly" class="btn btn-warning btn-lg w-100">
                                    📊 Predict Only
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="stopBot" class="btn btn-danger btn-lg w-100">
                                    ⛔ Stop Robot
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Bot Status</h6>
                                    <span id="botStatus" class="status-indicator status-inactive"></span>
                                    <span id="botStatusText">Stopped</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Market Status & Account Info -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Market Status</h5>
                        <div id="marketStatus">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Account Info</h5>
                        <div id="accountInfo">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Asset Selection -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Asset Selection</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Select Assets:</label>
                                <select id="symbolSelect" class="form-select" multiple size="5">
                                    {% for symbol in symbols %}
                                    <option value="{{ symbol }}" selected>{{ symbol }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Timeframe:</label>
                                <select id="timeframeSelect" class="form-select">
                                    <option value="1Min">1 Minute</option>
                                    <option value="5Min">5 Minutes</option>
                                    <option value="15Min">15 Minutes</option>
                                    <option value="30Min">30 Minutes</option>
                                    <option value="1Hour">1 Hour</option>
                                    <option value="4Hour">4 Hours</option>
                                    <option value="1Day">1 Day</option>
                                </select>
                                <button id="updatePredictions" class="btn btn-primary mt-2 w-100">
                                    Update Predictions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Predictions Table -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Current Predictions</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Direction</th>
                                        <th>Probability</th>
                                        <th>Duration</th>
                                        <th>Current Price</th>
                                        <th>Expected Change</th>
                                    </tr>
                                </thead>
                                <tbody id="predictionsTable">
                                    <tr>
                                        <td colspan="6" class="text-center">No predictions yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Prediction Chart</h5>
                        <div id="predictionChart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Price Chart</h5>
                        <div id="priceChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Positions -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Current Positions</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Quantity</th>
                                        <th>Entry Price</th>
                                        <th>Current Price</th>
                                        <th>P&L</th>
                                        <th>P&L %</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTable">
                                    <tr>
                                        <td colspan="6" class="text-center">No positions</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update functions
        function updateMarketStatus() {
            $.get('/get_market_status', function(data) {
                let html = '';
                if (data.is_open) {
                    html = '<p class="text-success">🟢 Market is OPEN</p>';
                } else {
                    html = '<p class="text-danger">🔴 Market is CLOSED</p>';
                }
                html += `<p>Next Open: ${new Date(data.next_open).toLocaleString()}</p>`;
                html += `<p>Next Close: ${new Date(data.next_close).toLocaleString()}</p>`;
                $('#marketStatus').html(html);
            });
        }

        function updateAccountInfo() {
            $.get('/get_account_info', function(data) {
                if (data.account) {
                    let html = `
                        <p>💰 Cash: $${parseFloat(data.account.cash).toFixed(2)}</p>
                        <p>📊 Portfolio: $${parseFloat(data.account.portfolio_value).toFixed(2)}</p>
                        <p>💸 Buying Power: $${parseFloat(data.account.buying_power).toFixed(2)}</p>
                    `;
                    $('#accountInfo').html(html);
                }
                
                // Update bot status
                if (data.bot_status === 'auto') {
                    $('#botStatus').removeClass('status-inactive').addClass('status-active');
                    $('#botStatusText').text('Auto Trading');
                } else if (data.bot_status === 'predict_only') {
                    $('#botStatus').removeClass('status-inactive').addClass('status-active');
                    $('#botStatusText').text('Predict Only');
                } else {
                    $('#botStatus').removeClass('status-active').addClass('status-inactive');
                    $('#botStatusText').text('Stopped');
                }
                
                // Update positions
                if (data.positions && Object.keys(data.positions).length > 0) {
                    let positionsHtml = '';
                    for (let symbol in data.positions) {
                        let pos = data.positions[symbol];
                        let plClass = pos.unrealized_pl >= 0 ? 'text-success' : 'text-danger';
                        positionsHtml += `
                            <tr>
                                <td>${symbol}</td>
                                <td>${pos.qty}</td>
                                <td>$${parseFloat(pos.avg_entry_price).toFixed(2)}</td>
                                <td>$${parseFloat(pos.current_price).toFixed(2)}</td>
                                <td class="${plClass}">$${parseFloat(pos.unrealized_pl).toFixed(2)}</td>
                                <td class="${plClass}">${(pos.unrealized_plpc * 100).toFixed(2)}%</td>
                            </tr>
                        `;
                    }
                    $('#positionsTable').html(positionsHtml);
                } else {
                    $('#positionsTable').html('<tr><td colspan="6" class="text-center">No positions</td></tr>');
                }
            });
        }

        function updatePredictions() {
            let selectedSymbols = $('#symbolSelect').val();
            let timeframe = $('#timeframeSelect').val();
            
            $.ajax({
                url: '/get_predictions',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    symbols: selectedSymbols,
                    timeframe: timeframe
                }),
                success: function(predictions) {
                    if (predictions.length > 0) {
                        let html = '';
                        predictions.forEach(pred => {
                            let dirClass = pred.direction === 'UP' ? 'text-success' : 'text-danger';
                            let arrow = pred.direction === 'UP' ? '⬆️' : '⬇️';
                            html += `
                                <tr>
                                    <td>${pred.symbol}</td>
                                    <td class="${dirClass}">${arrow} ${pred.direction}</td>
                                    <td>${(pred.probability * 100).toFixed(1)}%</td>
                                    <td>${pred.duration_minutes} min</td>
                                    <td>$${pred.current_price.toFixed(2)}</td>
                                    <td class="${dirClass}">${pred.predicted_change_pct.toFixed(2)}%</td>
                                </tr>
                            `;
                        });
                        $('#predictionsTable').html(html);
                    } else {
                        $('#predictionsTable').html('<tr><td colspan="6" class="text-center">No predictions available</td></tr>');
                    }
                }
            });
        }

        function updateCharts() {
            // Update prediction chart
            $.get('/get_prediction_chart', function(graphJSON) {
                Plotly.newPlot('predictionChart', JSON.parse(graphJSON).data, JSON.parse(graphJSON).layout);
            });
            
            // Update price chart for first selected symbol
            let selectedSymbols = $('#symbolSelect').val();
            let timeframe = $('#timeframeSelect').val();
            
            if (selectedSymbols && selectedSymbols.length > 0) {
                $.get(`/get_chart_data/${selectedSymbols[0]}/${timeframe}`, function(graphJSON) {
                    if (!graphJSON.error) {
                        Plotly.newPlot('priceChart', JSON.parse(graphJSON).data, JSON.parse(graphJSON).layout);
                    }
                });
            }
        }

        // Button handlers
        $('#startBot').click(function() {
            $.post('/start_bot', function(response) {
                alert(response.message);
                updateAccountInfo();
            });
        });

        $('#predictOnly').click(function() {
            $.post('/predict_only', function(response) {
                alert(response.message);
                updateAccountInfo();
            });
        });

        $('#stopBot').click(function() {
            $.post('/stop_bot', function(response) {
                alert(response.message);
                updateAccountInfo();
            });
        });

        $('#updatePredictions').click(function() {
            updatePredictions();
            updateCharts();
        });

        // Auto-update every 30 seconds
        setInterval(function() {
            updateMarketStatus();
            updateAccountInfo();
            updatePredictions();
            updateCharts();
        }, 30000);

        // Initial load
        $(document).ready(function() {
            updateMarketStatus();
            updateAccountInfo();
            updatePredictions();
            updateCharts();
        });
    </script>
</body>
</html>
